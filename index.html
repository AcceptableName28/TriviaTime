<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Trivia Ultimate</title>

  <style>
    :root{
      --p1:#8e44ad;
      --p2:#2980b9;
      --bg:#2c3e50;
      --card:#ecf0f1;
      --text:#14212c;
      --accent:#f1c40f;
      --muted: rgba(255,255,255,0.14);
      --muted2: rgba(0,0,0,0.12);
      --good:#27ae60;
      --bad:#c0392b;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);

      height:100svh;
      height:100dvh;
      overflow:hidden;

      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);

      display:flex;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:720px;
      height:100%;
      min-height:0;

      display:flex;
      flex-direction:column;
    }

    .header{
      flex:0 0 auto;
      height:46px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      background: rgba(0,0,0,0.22);
      color:#fff;
    }
    .score-box{
      min-width:64px;
      text-align:center;
      line-height:1;
    }
    .score-val{ font-size:1.35rem; font-weight:950; line-height:1; }
    .score-name{ margin-top:2px; font-size:0.62rem; font-weight:950; letter-spacing:0.8px; text-transform:uppercase; opacity:0.9; }
    .center-info{
      width:60%;
      max-width:360px;
      text-align:center;
      line-height:1.05;
      padding:0 6px;
    }
    #modeText{ font-size:0.74rem; font-weight:950; }
    #subText{
      font-size:0.62rem;
      opacity:0.75;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .loader{
      width:14px; height:14px;
      border:3px solid rgba(255,255,255,0.2);
      border-top:3px solid var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      display:none;
      margin:4px auto 0;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .main{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:10px 12px 8px;
    }

    .card{
      flex:1 1 auto;
      min-height:0;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 10px 22px rgba(0,0,0,0.28);
      overflow:hidden;
      position:relative;

      display:flex;
      flex-direction:column;
      padding:10px;
      gap:8px;
    }

    .timer-track{
      position:absolute;
      top:0; left:0;
      width:100%;
      height:6px;
      background:rgba(0,0,0,0.08);
    }
    .timer-fill{
      height:100%;
      width:100%;
      background:var(--accent);
      transition:width 0.1s linear;
    }

    .tag{
      align-self:center;
      margin-top:8px;
      background:#95a5a6;
      color:#fff;
      padding:4px 10px;
      border-radius:999px;
      font-size:0.64rem;
      font-weight:950;
      text-transform:uppercase;
    }

    .question{
      margin:0;
      padding:0 4px;
      text-align:center;
      font-weight:950;
      font-size:1.02rem;
      line-height:1.18;

      max-height: 4.6em;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .options{
      display:none;
      flex:0 0 auto;
      gap:7px;
      flex-direction:column;
    }
    .option-btn{
      border:none;
      border-radius:12px;
      background: rgba(44,62,80,0.10);
      color:var(--text);
      font-weight:950;
      font-size:0.86rem;
      text-align:left;
      padding:9px 10px;
      box-shadow:0 2px 0 rgba(0,0,0,0.08);
    }
    .option-btn:active{ transform: translateY(2px); }
    .opt-label{ display:inline-block; min-width:24px; opacity:0.85; font-weight:950; }
    .option-btn.locked{ background: rgba(241,196,15,0.24); box-shadow:0 0 0 2px rgba(241,196,15,0.52) inset; }
    .option-btn.correct{ background: rgba(46,204,113,0.24); box-shadow:0 0 0 2px rgba(46,204,113,0.52) inset; }

    .answer{
      flex:0 0 auto;
      background: var(--good);
      color:#fff;
      border-radius:12px;
      padding:9px 10px;
      min-height:38px;

      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;

      font-weight:950;
      font-size:0.92rem;

      opacity:0;
      transition:opacity 0.25s;

      max-height: 3.8em;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .answer.visible{ opacity:1; }

    .controls{
      flex:0 0 auto;
      background: rgba(0,0,0,0.30);
      border-radius:14px;
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }

    select, button{ border:none; border-radius:10px; font-weight:950; }

    .catSelect{
      height:34px;
      font-size:0.74rem;
      color:#fff;
      background: var(--muted);
      padding:0 10px;

      width: max-content;
      max-width: 100%;
    }

    .btn{
      height:34px;
      font-size:0.74rem;
      color:#fff;
      background: var(--muted);
      padding:0 10px;
      width:max-content;
      min-width: max-content;
      cursor:pointer;
    }
    .btn.on{ background: rgba(241,196,15,0.70); color:#14212c; }
    .btn:active{ transform: translateY(2px); }

    .buzzer-row{ display:flex; gap:10px; justify-content:center; }
    .buzzer{
      height:44px;
      border-radius:12px;
      color:#fff;
      font-size:1.00rem;
      font-weight:1000;
      text-transform:uppercase;
      padding:0 14px;
      box-shadow:0 3px 0 rgba(0,0,0,0.22);
      width: min(48%, 320px);
    }
    .buzzer:active{ transform: translateY(3px); box-shadow:none; }
    .p1{ background: var(--p1); }
    .p2{ background: var(--p2); }

    .locked .buzzer{ opacity:0.35; pointer-events:none; }
    .buzzer.winner{ opacity:1 !important; box-shadow:0 0 12px rgba(255,255,255,0.7); }

    .admin-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      opacity:0.30;
      pointer-events:none;
    }
    .activeAdmin .admin-row{ opacity:1; pointer-events:auto; }

    .admin{
      height:36px;
      font-size:0.78rem;
      font-weight:1000;
      border-radius:10px;
      color:#fff;
      padding:0 12px;
      width:max-content;
      min-width:max-content;
    }
    .showBtn{ background:#f39c12; color:#14212c; }
    .correctBtn{ background: var(--good); }
    .wrongBtn{ background: var(--bad); }
    .nextBtn{ background:#7f8c8d; }

    .meta-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .meta{
      height:34px;
      font-size:0.74rem;
      font-weight:1000;
      border-radius:10px;
      color:#fff;
      background: rgba(255,255,255,0.14);
      padding:0 12px;
      width:max-content;
      min-width:max-content;
    }
    .danger{ background: rgba(231,76,60,0.65); }
    .pause{ background: rgba(52,152,219,0.55); color:#122231; }
    .good{ background: rgba(46,204,113,0.55); color:#122231; }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(12px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,0.86);
      color:#fff;
      padding:9px 10px;
      border-radius:12px;
      font-weight:950;
      font-size:0.82rem;
      display:none;
      max-width:92vw;
      text-align:center;
      z-index:9999;
    }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:10000;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .sheet{
      width:min(640px, 96vw);
      background:#fff;
      border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,0.35);
      overflow:hidden;
    }
    .sheetHead{
      padding:12px 14px;
      background: rgba(20,33,44,0.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sheetTitle{ font-weight:1000; font-size:0.98rem; }
    .sheetClose{
      background: rgba(0,0,0,0.12);
      color:#14212c;
      padding:8px 10px;
      border-radius:12px;
      font-weight:1000;
      font-size:0.84rem;
    }
    .sheetBody{
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .setRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 10px;
      border-radius:12px;
      background: rgba(44,62,80,0.06);
    }
    .setLabel{
      font-weight:1000;
      font-size:0.88rem;
      color:#14212c;
    }
    .setHint{
      font-size:0.74rem;
      opacity:0.7;
      margin-top:2px;
      font-weight:900;
    }
    .setControl{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      height:34px;
      padding:0 12px;
      border-radius:999px;
      background: rgba(20,33,44,0.10);
      color:#14212c;
      font-weight:1000;
      font-size:0.78rem;
      width:max-content;
      min-width:max-content;
    }
    .chip.on{ background: rgba(241,196,15,0.65); }
    .sheetSelect{
      height:34px;
      padding:0 10px;
      border-radius:12px;
      background: rgba(20,33,44,0.10);
      color:#14212c;
      font-weight:1000;
      font-size:0.78rem;
      border:none;
    }

    @media (max-height: 740px){
      .header{ height:44px; }
      .main{ padding:8px 10px 6px; gap:7px; }
      .card{ padding:9px; }
      .buzzer{ height:42px; font-size:0.96rem; }
      .admin{ height:34px; }
      .btn,.meta,.catSelect{ height:33px; }
      .question{ font-size:0.98rem; }
      .option-btn{ font-size:0.84rem; padding:8px 10px; }
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <div class="header">
      <div class="score-box">
        <div class="score-val" id="s1">0</div>
        <div class="score-name" id="n1" style="color:#d2b4de">PAULINE</div>
      </div>

      <div class="center-info">
        <div id="modeText">READY</div>
        <div id="subText">Loading‚Ä¶</div>
        <div class="loader" id="loader"></div>
      </div>

      <div class="score-box">
        <div class="score-val" id="s2">0</div>
        <div class="score-name" id="n2" style="color:#a9cce3">JON</div>
      </div>
    </div>

    <div class="main">
      <div class="card" id="card">
        <div class="timer-track"><div class="timer-fill" id="timer"></div></div>
        <div class="tag" id="tag">CUSTOM</div>
        <p class="question" id="q">Tap ‚ÄúNext ‚Üí‚Äù to start!</p>
        <div class="options" id="opts"></div>
        <div class="answer" id="ans">ANSWER HIDDEN</div>
      </div>

      <div class="controls" id="controls">
        <div class="row">
          <select class="catSelect" id="cat">
            <option value="mixed" selected>MIXED</option>
            <option value="custom">CUSTOM (Friends/HIMYM/Star Wars/90s)</option>
            <option value="alina">ALINA (AGE 3‚Äì5)</option>
            <option value="pop">POP CULTURE</option>
            <option value="80s">1980s</option>
            <option value="90s">1990s</option>
            <option value="2000s">2000s</option>
            <option value="disney">DISNEY</option>
            <option value="ww2">WORLD WAR 2</option>
            <option value="tv">TV</option>
            <option value="movies">MOVIES</option>
            <option value="music">MUSIC</option>
            <option value="science">SCIENCE</option>
            <option value="history">HISTORY</option>
            <option value="computers">COMPUTERS</option>
          </select>

          <button class="btn" id="settingsBtn">SETTINGS</button>
        </div>

        <div class="buzzer-row">
          <button class="buzzer p1" id="b1">PAULINE</button>
          <button class="buzzer p2" id="b2">JON</button>
        </div>

        <div class="admin-row" id="adminRow">
          <button class="admin showBtn" id="show">Show Answer</button>
          <button class="admin correctBtn" id="correct">Correct (+1)</button>
          <button class="admin wrongBtn" id="wrong">Wrong (0)</button>
          <button class="admin nextBtn" id="next">Next ‚Üí</button>
        </div>

        <div class="meta-row">
          <button class="meta danger" id="undo">Undo</button>
          <button class="meta pause" id="pause">Pause</button>
          <button class="meta good" id="reset">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="overlay" id="sheetOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="sheetHead">
        <div class="sheetTitle">Settings</div>
        <button class="sheetClose" id="sheetClose">Close</button>
      </div>

      <div class="sheetBody">
        <div class="setRow">
          <div>
            <div class="setLabel">SFX</div>
            <div class="setHint">Buzzer sound + haptics</div>
          </div>
          <div class="setControl">
            <button class="chip" id="sfxChip">ON</button>
          </div>
        </div>

        <div class="setRow">
          <div>
            <div class="setLabel">Difficulty</div>
            <div class="setHint">Default Medium (recommended)</div>
          </div>
          <div class="setControl">
            <select class="sheetSelect" id="diffSel">
              <option value="easy">Easy</option>
              <option value="medium" selected>Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
        </div>

        <div class="setRow">
          <div>
            <div class="setLabel">Random Category</div>
            <div class="setHint">Randomizes category each question</div>
          </div>
          <div class="setControl">
            <button class="chip" id="randomChip">OFF</button>
          </div>
        </div>

        <div class="setRow">
          <div>
            <div class="setLabel">Best of 10</div>
            <div class="setHint">Always 10, sudden-death tiebreak</div>
          </div>
          <div class="setControl">
            <button class="chip" id="best10Chip">OFF</button>
          </div>
        </div>

        <div class="setRow">
          <div>
            <div class="setLabel">Steal Mode</div>
            <div class="setHint">If wrong, other player can steal +1</div>
          </div>
          <div class="setControl">
            <button class="chip" id="stealChip">OFF</button>
          </div>
        </div>

        <div class="setRow">
          <div>
            <div class="setLabel">Lightning Round</div>
            <div class="setHint">60s rapid questions (MC only)</div>
          </div>
          <div class="setControl">
            <button class="chip" id="lightChip">OFF</button>
          </div>
        </div>

        <div class="setRow">
          <div>
            <div class="setLabel">Nerd Mode</div>
            <div class="setHint">More sci-fi/computers/Star vibes in Mixed</div>
          </div>
          <div class="setControl">
            <button class="chip" id="nerdChip">OFF</button>
          </div>
        </div>

        <div class="setRow">
          <div>
            <div class="setLabel">Names</div>
            <div class="setHint">Edit player names</div>
          </div>
          <div class="setControl">
            <button class="chip" id="namesChip">Edit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  /* -------------------- CONFIG -------------------- */
  const QUESTION_SECONDS = 30;
  const TICK_MS = 100;

  const LIGHTNING_SECONDS = 60;

  const API_TIMEOUT_MS = 7000;
  const API_BATCH_SIZE = 30;
  const WARMUP_BATCHES = 2;

  /* Alina prefetch (fast start / staged loading) */
  const ALINA_FAST_START_MIN = 50;
  const ALINA_STAGE1_TARGET = 500;
  const ALINA_STAGE2_TRIGGER_AT = 450;  // when served count reaches this, resume to load more
  const ALINA_STAGE2_ADD = 500;         // load another 500
  const ALINA_STAGE2_TARGET = ALINA_STAGE1_TARGET + ALINA_STAGE2_ADD; // 1000

  /* Strict no-repeat across sessions (hashed IDs) */
  const LS_SEEN = "trivia_seen_hash_v2";
  const LS_NAMES = "trivia_names_v4";
  const LS_SETTINGS = "trivia_settings_v4";

  /* Filter out annoying question styles */
  const BAD_PATTERNS = [
    "all of the above",
    "none of the above"
  ];

  /* -------------------- UI -------------------- */
  const ui = {
    s1: document.getElementById("s1"),
    s2: document.getElementById("s2"),
    n1: document.getElementById("n1"),
    n2: document.getElementById("n2"),
    modeText: document.getElementById("modeText"),
    subText: document.getElementById("subText"),
    loader: document.getElementById("loader"),

    tag: document.getElementById("tag"),
    q: document.getElementById("q"),
    opts: document.getElementById("opts"),
    ans: document.getElementById("ans"),
    timer: document.getElementById("timer"),

    cat: document.getElementById("cat"),
    controls: document.getElementById("controls"),
    b1: document.getElementById("b1"),
    b2: document.getElementById("b2"),
    show: document.getElementById("show"),
    correct: document.getElementById("correct"),
    wrong: document.getElementById("wrong"),
    next: document.getElementById("next"),
    undo: document.getElementById("undo"),
    pause: document.getElementById("pause"),
    reset: document.getElementById("reset"),
    toast: document.getElementById("toast"),

    settingsBtn: document.getElementById("settingsBtn"),
    sheetOverlay: document.getElementById("sheetOverlay"),
    sheetClose: document.getElementById("sheetClose"),

    sfxChip: document.getElementById("sfxChip"),
    diffSel: document.getElementById("diffSel"),
    randomChip: document.getElementById("randomChip"),
    best10Chip: document.getElementById("best10Chip"),
    stealChip: document.getElementById("stealChip"),
    lightChip: document.getElementById("lightChip"),
    nerdChip: document.getElementById("nerdChip"),
    namesChip: document.getElementById("namesChip"),
  };

  /* -------------------- STATE -------------------- */
  let apiToken = null;

  let names = { p1: "Pauline", p2: "Jon" };
  let scores = { p1: 0, p2: 0 };

  let settings = {
    sfx: true,
    difficulty: "medium",
    randomCategory: false,
    best10: false,
    steal: false,
    lightning: false,
    nerd: false
  };

  let currentQ = null;            // { cat, q, a, type:'mc'|'open', options?, correctIndex? }
  let buzzWinner = 0;             // 0 none, 1 p1, 2 p2
  let lockedGuessIndex = null;    // MC selection
  let paused = false;

  let timerInterval = null;
  let timeLeft = QUESTION_SECONDS;

  /* best-of-10 */
  let matchQCount = 0;
  let suddenDeath = false;
  let matchLocked = false;

  /* lightning */
  let lightningTimeLeft = LIGHTNING_SECONDS;
  let lightningInterval = null;

  /* strict no-repeat set (hashed IDs) */
  let seen = new Set();

  /* per-topic banks */
  const banks = new Map();        // topic -> array of question objects
  const bankKeys = new Map();     // topic -> set of hashes in bank (for bank uniqueness)
  const workingDeck = new Map();  // topic -> shuffled array
  const fetching = new Set();     // topic being fetched to avoid spam

  const undoStack = [];

  /* Alina staged loading tracking */
  let alinaServedCount = 0;            // count served this session
  let alinaStage2Started = false;      // once true, we try to reach ALINA_STAGE2_TARGET

  /* -------------------- DATA -------------------- */
  const CUSTOM = [
    {cat:"Friends", q:"In FRIENDS, what is the name of Joey's bedtime penguin?", a:"Hugsy", type:"open"},
    {cat:"Friends", q:"In FRIENDS, what name does Phoebe use as her alter ego?", a:"Regina Phalange", type:"open"},
    {cat:"Friends", q:"In FRIENDS, what is Chandler Bing's middle name?", a:"Muriel", type:"open"},
    {cat:"Friends", q:"In FRIENDS, what color is Monica and Rachel‚Äôs apartment door?", a:"Purple", type:"open"},
    {cat:"Friends", q:"In FRIENDS, what is the name of the coffee shop the group hangs out at?", a:"Central Perk", type:"open"},

    {cat:"HIMYM", q:"In How I Met Your Mother, where does the gang frequently hang out?", a:"MacLaren's Pub", type:"open"},
    {cat:"HIMYM", q:"In How I Met Your Mother, what item does Ted steal for Robin?", a:"A blue French horn", type:"open"},
    {cat:"HIMYM", q:"In How I Met Your Mother, what is Barney‚Äôs catchphrase?", a:"Legendary", type:"open"},

    {cat:"Star Wars", q:"In Star Wars, what species is Admiral Ackbar?", a:"Mon Calamari", type:"open"},
    {cat:"Star Wars", q:"In Star Wars, what is the name of Han Solo‚Äôs ship?", a:"The Millennium Falcon", type:"open"},
    {cat:"Star Wars", q:"In Star Wars, what is the name of the planet where Luke is raised?", a:"Tatooine", type:"open"},

    {cat:"1980s", q:"Which sci-fi movie features a DeLorean time machine?", a:"Back to the Future", type:"open"},
    {cat:"1990s", q:"What is the name of the 90s handheld virtual pet?", a:"Tamagotchi", type:"open"},
    {cat:"1990s", q:"Which toy slime brand was famously marketed in the 90s?", a:"Gak", type:"open"},
    {cat:"2000s", q:"What video platform launched in 2005?", a:"YouTube", type:"open"},
    {cat:"Pop Culture", q:"In The Office (US), what company do they work for?", a:"Dunder Mifflin", type:"open"},
    {cat:"Disney", q:"In The Lion King, what is Simba‚Äôs father‚Äôs name?", a:"Mufasa", type:"open"},
    {cat:"World War 2", q:"What was the code name for the Allied invasion of Normandy?", a:"Operation Overlord", type:"open"},
  ];

  const TOPIC_LABEL = {
    mixed: "Mixed",
    custom: "Custom",
    alina: "Alina (Age 3‚Äì5)",
    pop: "Pop Culture",
    "80s": "1980s",
    "90s": "1990s",
    "2000s": "2000s",
    disney: "Disney",
    ww2: "World War 2",
    tv: "TV",
    movies: "Movies",
    music: "Music",
    science: "Science",
    history: "History",
    computers: "Computers"
  };

  /* OpenTDB category IDs */
  const OTD = { gen:9, movies:11, music:12, tv:14, science:17, computers:18, history:23 };

  /* The Trivia API (v2) categories enum includes: general_knowledge, science, geography, food_and_drink, etc.  [oai_citation:1‚Ä°The Trivia API](https://the-trivia-api.com/docs/v2/?utm_source=chatgpt.com) */
  const ALINA_TRIVIAAPI_CATS = [
    "general_knowledge",
    "science",
    "geography",
    "food_and_drink",
    "society_and_culture"
  ];

  /* -------------------- UTIL -------------------- */
  function toast(msg){
    ui.toast.textContent = msg;
    ui.toast.style.display = "block";
    clearTimeout(ui.toast._t);
    ui.toast._t = setTimeout(()=> ui.toast.style.display="none", 1300);
  }

  function setLoading(on, mode, sub){
    ui.loader.style.display = on ? "block" : "none";
    if (mode) ui.modeText.textContent = mode;
    if (sub) ui.subText.textContent = sub;
  }

  function shuffle(arr){
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function decodeHtml(str){
    const t = document.createElement("textarea");
    t.innerHTML = str;
    return t.value;
  }

  function normalize(str){
    return (str || "").trim().toLowerCase().replace(/\s+/g," ");
  }

  /* FNV-1a 32-bit hash -> hex string (compact localStorage) */
  function fnv1a(str){
    let h = 0x811c9dc5;
    for (let i=0; i<str.length; i++){
      h ^= str.charCodeAt(i);
      // h *= 16777619 (with 32-bit overflow)
      h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
    }
    return ("00000000" + h.toString(16)).slice(-8);
  }

  function stableKey(qObj){
    const c = normalize(qObj.cat);
    const q = normalize(qObj.q);
    const a = normalize(qObj.a);
    return `${c}||${q}||${a}`;
  }

  function hashIdFor(qObj){
    return fnv1a(stableKey(qObj));
  }

  function loadSeen(){
    try{
      const raw = localStorage.getItem(LS_SEEN);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) seen = new Set(arr);
    }catch(e){}
  }
  function saveSeen(){
    try{ localStorage.setItem(LS_SEEN, JSON.stringify(Array.from(seen))); }catch(e){}
  }

  function loadNames(){
    try{
      const raw = localStorage.getItem(LS_NAMES);
      if (!raw) return;
      const n = JSON.parse(raw);
      if (n && typeof n.p1 === "string" && typeof n.p2 === "string"){
        names = { p1: n.p1 || "Player 1", p2: n.p2 || "Player 2" };
      }
    }catch(e){}
  }
  function saveNames(){
    try{ localStorage.setItem(LS_NAMES, JSON.stringify(names)); }catch(e){}
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem(LS_SETTINGS);
      if (!raw) return;
      const s = JSON.parse(raw);
      if (s && typeof s === "object"){
        settings = { ...settings, ...s };
      }
    }catch(e){}
  }
  function saveSettings(){
    try{ localStorage.setItem(LS_SETTINGS, JSON.stringify(settings)); }catch(e){}
  }

  function applyNames(){
    ui.n1.textContent = names.p1.toUpperCase();
    ui.n2.textContent = names.p2.toUpperCase();
    ui.b1.textContent = names.p1.toUpperCase();
    ui.b2.textContent = names.p2.toUpperCase();
    document.title = `${names.p1} vs ${names.p2} Trivia`;
  }

  function applySettingsUI(){
    ui.sfxChip.classList.toggle("on", settings.sfx);
    ui.sfxChip.textContent = settings.sfx ? "ON" : "OFF";

    ui.diffSel.value = settings.difficulty || "medium";

    ui.randomChip.classList.toggle("on", settings.randomCategory);
    ui.randomChip.textContent = settings.randomCategory ? "ON" : "OFF";

    ui.best10Chip.classList.toggle("on", settings.best10);
    ui.best10Chip.textContent = settings.best10 ? "ON" : "OFF";

    ui.stealChip.classList.toggle("on", settings.steal);
    ui.stealChip.textContent = settings.steal ? "ON" : "OFF";

    ui.lightChip.classList.toggle("on", settings.lightning);
    ui.lightChip.textContent = settings.lightning ? "ON" : "OFF";

    ui.nerdChip.classList.toggle("on", settings.nerd);
    ui.nerdChip.textContent = settings.nerd ? "ON" : "OFF";
  }

  function updateScores(){
    ui.s1.textContent = String(scores.p1);
    ui.s2.textContent = String(scores.p2);
  }

  function modeLine(){
    if (settings.lightning) return `LIGHTNING ‚Ä¢ ${lightningTimeLeft}s`;
    if (!settings.best10) return "READY";
    if (matchLocked) return "BEST OF 10 (FINISHED)";
    if (suddenDeath) return "SUDDEN DEATH";
    return `BEST OF 10 ‚Ä¢ Q ${matchQCount}/10`;
  }

  function setAnswerVisible(on){
    ui.ans.classList.toggle("visible", !!on);
  }

  function setAdminActive(on){
    ui.controls.classList.toggle("activeAdmin", !!on);
  }

  function setLocked(on){
    ui.controls.classList.toggle("locked", !!on);
  }

  function clearOptions(){
    ui.opts.innerHTML = "";
    ui.opts.style.display = "none";
    lockedGuessIndex = null;
  }

  function renderOptions(qObj){
    clearOptions();
    if (!qObj || qObj.type !== "mc" || !Array.isArray(qObj.options) || qObj.options.length !== 4) return;

    ui.opts.style.display = "flex";
    const labels = ["A","B","C","D"];

    qObj.options.forEach((txt, idx) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "option-btn";
      btn.innerHTML = `<span class="opt-label">${labels[idx]}.</span> ${txt}`;
      btn.addEventListener("click", () => {
        if (!settings.lightning && buzzWinner === 0){
          toast("Buzz first");
          return;
        }
        lockedGuessIndex = idx;
        Array.from(ui.opts.querySelectorAll(".option-btn")).forEach(b => b.classList.remove("locked"));
        btn.classList.add("locked");
        if (settings.sfx) haptic(15);
        toast("Answer locked");
      });
      ui.opts.appendChild(btn);
    });
  }

  function revealCorrectOption(){
    if (!currentQ || currentQ.type !== "mc") return;
    const idx = currentQ.correctIndex;
    const btns = Array.from(ui.opts.querySelectorAll(".option-btn"));
    if (Number.isInteger(idx) && btns[idx]) btns[idx].classList.add("correct");
  }

  function haptic(ms=18){
    try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(e){}
  }

  function beep(freq=520, ms=80){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = freq;
      gain.gain.value = 0.05;
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start();
      setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
    }catch(e){}
  }

  function sfxBuzz(){ if (!settings.sfx) return; haptic(20); beep(520, 80); }
  function sfxCorrect(){ if (!settings.sfx) return; haptic(20); beep(780, 60); setTimeout(()=>beep(980, 60), 80); }
  function sfxWrong(){ if (!settings.sfx) return; haptic(20); beep(220, 110); }

  /* -------------------- BANK / DECK -------------------- */
  function ensureTopic(topic){
    if (!banks.has(topic)) banks.set(topic, []);
    if (!bankKeys.has(topic)) bankKeys.set(topic, new Set());
  }

  function addToBank(topic, items){
    ensureTopic(topic);
    const arr = banks.get(topic);
    const keys = bankKeys.get(topic);

    for (const it of items){
      const id = hashIdFor(it);
      if (!keys.has(id)){
        keys.add(id);
        arr.push(it);
      }
    }
  }

  function resetDeck(topic){
    const src = (banks.get(topic) || []);
    workingDeck.set(topic, shuffle(src.slice()));
  }

  function passesFilters(qObj){
    const q = normalize(qObj.q);
    for (const pat of BAD_PATTERNS){
      if (q.includes(pat)) return false;
    }
    if (qObj.type === "mc"){
      if (!Array.isArray(qObj.options) || qObj.options.length !== 4) return false;
      if (!Number.isInteger(qObj.correctIndex)) return false;
    }
    return true;
  }

  /* Alina-safe filter: very kid-friendly heuristics */
  function passesAlinaSafe(qObj){
    if (!qObj || qObj.type !== "mc") return false;

    const q = (qObj.q || "").trim();
    const a = (qObj.a || "").trim();
    const opts = qObj.options || [];

    // Basic requirements
    if (!q.endsWith("?")) return false;
    if (q.length < 8 || q.length > 80) return false;

    // Reject numbers/years
    if (/\d/.test(q)) return false;

    // Keep simple words (rough heuristic)
    const words = q.replace(/[^\w\s'?]/g,"").split(/\s+/).filter(Boolean);
    if (words.length > 12) return false;

    // Reject complex phrasing
    const badStarts = ["which of these", "according to", "in what year", "what year", "who was", "what is the capital", "what is the name of the", "how many"];
    const qLower = normalize(q);
    for (const s of badStarts){
      if (qLower.startsWith(s)) return false;
    }
    if (qLower.includes("following")) return false;

    // Answer + options short
    if (a.length > 24) return false;
    if (opts.some(x => (x || "").length > 24)) return false;

    // Avoid rare punctuation/quotes
    if (/[‚Äú‚Äù"()]/.test(q)) return false;
    if (q.includes(",")) return false;

    return true;
  }

  function pickFromTopic(topic){
    ensureTopic(topic);
    if (!workingDeck.has(topic)) resetDeck(topic);
    const deck = workingDeck.get(topic);

    while (deck.length){
      const qObj = deck.shift();
      const id = hashIdFor(qObj);
      if (seen.has(id)) continue;
      if (!passesFilters(qObj)) continue;
      if (topic === "alina" && !passesAlinaSafe(qObj)) continue;

      seen.add(id);
      saveSeen();
      return qObj;
    }

    resetDeck(topic);
    const deck2 = workingDeck.get(topic);
    while (deck2.length){
      const qObj = deck2.shift();
      const id = hashIdFor(qObj);
      if (seen.has(id)) continue;
      if (!passesFilters(qObj)) continue;
      if (topic === "alina" && !passesAlinaSafe(qObj)) continue;

      seen.add(id);
      saveSeen();
      return qObj;
    }

    return null;
  }

  /* -------------------- OPENTDB FETCH -------------------- */
  function fetchWithTimeout(url, ms){
    return new Promise((resolve,reject)=>{
      const controller = new AbortController();
      const t = setTimeout(()=>{ controller.abort(); reject(new Error("timeout")); }, ms);
      fetch(url, {cache:"no-store", signal:controller.signal})
        .then(r => { clearTimeout(t); resolve(r); })
        .catch(e => { clearTimeout(t); reject(e); });
    });
  }

  async function getToken(){
    try{
      const r = await fetchWithTimeout("https://opentdb.com/api_token.php?command=request", API_TIMEOUT_MS);
      const d = await r.json();
      if (d.response_code === 0) return d.token;
    }catch(e){}
    return null;
  }

  function buildMCFromOpenTDB(item){
    const q = decodeHtml(item.question);
    const correct = decodeHtml(item.correct_answer);
    const incorrect = (item.incorrect_answers || []).map(decodeHtml);
    const all = shuffle([correct, ...incorrect]);
    const correctIndex = all.indexOf(correct);
    return {
      cat: decodeHtml(item.category || "Trivia"),
      q,
      a: correct,
      type: "mc",
      options: all,
      correctIndex
    };
  }

  function topicToPlan(topic){
    if (topic === "mixed" && settings.nerd){
      return [
        {catId: OTD.tv, w: 2},
        {catId: OTD.movies, w: 2},
        {catId: OTD.computers, w: 2},
        {catId: OTD.science, w: 2},
        {catId: OTD.gen, w: 1},
        {catId: OTD.history, w: 1},
      ];
    }

    switch(topic){
      case "tv": return [{catId: OTD.tv, w: 1}];
      case "movies": return [{catId: OTD.movies, w: 1}];
      case "music": return [{catId: OTD.music, w: 1}];
      case "science": return [{catId: OTD.science, w: 1}];
      case "computers": return [{catId: OTD.computers, w: 1}];
      case "history": return [{catId: OTD.history, w: 1}];
      case "ww2": return [{catId: OTD.history, w: 1}];
      case "disney": return [{catId: OTD.movies, w: 2},{catId: OTD.gen, w:1}];
      case "80s":
      case "90s":
      case "2000s":
        return [{catId: OTD.music, w:2},{catId: OTD.tv, w:1},{catId: OTD.movies, w:1},{catId: OTD.gen, w:1}];
      case "pop":
        return [{catId: OTD.tv, w:2},{catId: OTD.movies, w:2},{catId: OTD.music, w:1},{catId: OTD.gen, w:1}];
      case "custom":
      case "alina":
        return [];
      case "mixed":
      default:
        return [
          {catId: OTD.gen, w:1},
          {catId: OTD.tv, w:1},
          {catId: OTD.movies, w:1},
          {catId: OTD.music, w:1},
          {catId: OTD.science, w:1},
          {catId: OTD.history, w:1},
          {catId: OTD.computers, w:1},
        ];
    }
  }

  function pickWeighted(plan){
    const total = plan.reduce((s,x)=>s+x.w,0);
    let r = Math.random() * total;
    for (const item of plan){
      r -= item.w;
      if (r <= 0) return item.catId;
    }
    return plan[0]?.catId;
  }

  async function fetchBatchOpenTDBFor(topic){
    if (!apiToken) return;
    if (topic === "custom" || topic === "alina") return;
    if (fetching.has(topic)) return;
    fetching.add(topic);

    try{
      const plan = topicToPlan(topic);
      if (!plan.length) return;

      const catId = pickWeighted(plan);
      if (!catId) return;

      let url = `https://opentdb.com/api.php?amount=${API_BATCH_SIZE}&type=multiple&category=${catId}&difficulty=${settings.difficulty}`;
      url += `&token=${apiToken}`;

      const r = await fetchWithTimeout(url, API_TIMEOUT_MS);
      const data = await r.json();

      const items = (data.results || []).map(buildMCFromOpenTDB).filter(passesFilters);

      addToBank(topic, items);
      if (topic !== "mixed") addToBank("mixed", items);

      resetDeck(topic);
      if (topic !== "mixed") resetDeck("mixed");
    }catch(e){
      // ignore
    }finally{
      fetching.delete(topic);
    }
  }

  /* -------------------- THE TRIVIA API (ALINA) -------------------- */
  function buildMCFromTriviaAPI(item){
    // v2 format: question.text, correctAnswer, incorrectAnswers, category
    const q = (item?.question?.text ?? item?.question ?? "").toString();
    const correct = (item?.correctAnswer ?? item?.correct_answer ?? "").toString();
    const incorrect = (item?.incorrectAnswers ?? item?.incorrect_answers ?? []);
    const incArr = Array.isArray(incorrect) ? incorrect.map(x => (x ?? "").toString()) : [];

    const cleanQ = decodeHtml(q).trim();
    const cleanCorrect = decodeHtml(correct).trim();
    const cleanInc = incArr.map(x => decodeHtml(x).trim()).filter(Boolean);

    if (!cleanQ || !cleanCorrect || cleanInc.length < 3) return null;

    const all = shuffle([cleanCorrect, ...cleanInc.slice(0,3)]);
    const correctIndex = all.indexOf(cleanCorrect);

    return {
      cat: "Alina",
      q: cleanQ.endsWith("?") ? cleanQ : (cleanQ + "?"),
      a: cleanCorrect,
      type: "mc",
      options: all,
      correctIndex
    };
  }

  async function fetchBatchAlina(limit=50){
    // The Trivia API v2: categories + difficulties + limit  [oai_citation:2‚Ä°The Trivia API](https://the-trivia-api.com/?utm_source=chatgpt.com)
    // We always use easy for Alina.
    const cats = ALINA_TRIVIAAPI_CATS.join(",");
    const url = `https://the-trivia-api.com/v2/questions?limit=${limit}&difficulties=easy&categories=${encodeURIComponent(cats)}`;

    const r = await fetchWithTimeout(url, API_TIMEOUT_MS);
    const data = await r.json();
    const arr = Array.isArray(data) ? data : (data?.results || []);
    const built = [];
    for (const it of arr){
      const qObj = buildMCFromTriviaAPI(it);
      if (!qObj) continue;
      if (!passesFilters(qObj)) continue;
      if (!passesAlinaSafe(qObj)) continue;
      built.push(qObj);
    }
    return built;
  }

  async function ensureAlinaPrefetchTargets(){
    // Non-blocking staged prefetch:
    // - Stage 1 target = 500 (playable at 50)
    // - Stage 2 starts at served #450, target = 1000 total in bank
    ensureTopic("alina");

    const bank = banks.get("alina") || [];
    const target = alinaStage2Started ? ALINA_STAGE2_TARGET : ALINA_STAGE1_TARGET;

    // If already at/above target, do nothing.
    if (bank.length >= target) return;

    if (fetching.has("alina")) return;
    fetching.add("alina");

    try{
      // Refill-until-valid logic: try several batches until we make progress or hit attempts.
      let attempts = 0;
      let madeProgress = false;

      while (attempts < 10 && (banks.get("alina") || []).length < target){
        attempts++;

        const before = (banks.get("alina") || []).length;
        const batch = await fetchBatchAlina(50);

        // Remove anything already seen (strict)
        const filtered = batch.filter(qObj => !seen.has(hashIdFor(qObj)));
        addToBank("alina", filtered);
        resetDeck("alina");

        const after = (banks.get("alina") || []).length;
        if (after > before) madeProgress = true;

        // If we got nothing useful, keep trying a few times; otherwise yield control quickly.
        if (madeProgress && after >= Math.min(target, before + 100)) break;
        await new Promise(r => setTimeout(r, 120));
      }
    }catch(e){
      // ignore; we‚Äôll fallback gracefully
    }finally{
      fetching.delete("alina");
    }
  }

  /* -------------------- WARMUP / BACKGROUND FILL -------------------- */
  async function warmupOpenTDB(){
    const topics = ["mixed","tv","movies","music","science","history","computers","pop","80s","90s","2000s","disney","ww2"];
    for (let i=0;i<WARMUP_BATCHES;i++){
      for (const t of topics){
        ui.subText.textContent = `Warming up‚Ä¶ ${TOPIC_LABEL[t] || t}`;
        await fetchBatchOpenTDBFor(t);
      }
    }
    ui.subText.textContent = "Online ready ‚Ä¢ Loading more‚Ä¶";
  }

  async function backgroundFillOpenTDB(){
    const topics = ["mixed","tv","movies","music","science","history","computers","pop","80s","90s","2000s","disney","ww2"];
    while(true){
      if (!apiToken) return;

      for (const t of topics){
        ensureTopic(t);
        const count = (banks.get(t) || []).length;
        if (count < 220){
          ui.subText.textContent = `Fetching more‚Ä¶ ${TOPIC_LABEL[t] || t} ${count}/220`;
          await fetchBatchOpenTDBFor(t);
        }
      }
      await new Promise(r=>setTimeout(r, 900));
    }
  }

  async function alinaFastStartLoop(){
    // Start fetching until at least 50 Alina questions are queued, then keep going to 500.
    // This loop never blocks gameplay.
    while(true){
      try{
        ensureTopic("alina");
        const count = (banks.get("alina") || []).length;

        // Stage trigger: once served count reaches 450, start stage2
        if (!alinaStage2Started && alinaServedCount >= ALINA_STAGE2_TRIGGER_AT){
          alinaStage2Started = true;
        }

        const target = alinaStage2Started ? ALINA_STAGE2_TARGET : ALINA_STAGE1_TARGET;

        // Pause when at/above target
        if (count >= target){
          await new Promise(r => setTimeout(r, 1200));
          continue;
        }

        // UI status hint (not too spammy)
        if (ui.cat.value === "alina"){
          const label = alinaStage2Started ? `Alina loading‚Ä¶ ${count}/${ALINA_STAGE2_TARGET}` : `Alina loading‚Ä¶ ${count}/${ALINA_STAGE1_TARGET}`;
          ui.subText.textContent = label;
        }

        await ensureAlinaPrefetchTargets();

        await new Promise(r => setTimeout(r, 350));
      }catch(e){
        await new Promise(r => setTimeout(r, 1200));
      }
    }
  }

  /* -------------------- GAME FLOW -------------------- */
  function resetWinnerState(){
    buzzWinner = 0;
    lockedGuessIndex = null;
    ui.b1.classList.remove("winner");
    ui.b2.classList.remove("winner");
    Array.from(ui.opts.querySelectorAll(".option-btn")).forEach(b => b.classList.remove("locked","correct"));
  }

  function resetUIForNext(){
    clearInterval(timerInterval);
    ui.pause.textContent = "Pause";
    paused = false;

    timeLeft = QUESTION_SECONDS;
    ui.timer.style.width = "100%";

    ui.ans.style.background = getComputedStyle(document.documentElement).getPropertyValue("--good").trim() || "#27ae60";
    ui.ans.textContent = "ANSWER HIDDEN";
    setAnswerVisible(false);

    resetWinnerState();
    setLocked(false);
    setAdminActive(true);
    clearOptions();
  }

  function startTimer(){
    clearInterval(timerInterval);
    timeLeft = QUESTION_SECONDS;
    ui.timer.style.width = "100%";

    timerInterval = setInterval(() => {
      if (paused || settings.lightning) return;

      timeLeft -= (TICK_MS/1000);
      const pct = Math.max(0, (timeLeft/QUESTION_SECONDS)*100);
      ui.timer.style.width = pct + "%";

      if (timeLeft <= 0){
        clearInterval(timerInterval);
        setLocked(true);
        setAdminActive(true);
        toast("Time!");
      }
    }, TICK_MS);
  }

  function renderQuestion(qObj){
    currentQ = qObj;

    ui.tag.textContent = (qObj.cat || "Trivia").toUpperCase();
    ui.q.textContent = qObj.q || "‚Äî";
    ui.ans.textContent = qObj.a || "‚Äî";

    setAnswerVisible(false);
    renderOptions(qObj);
  }

  function currentTopic(){
    if (!settings.randomCategory) return ui.cat.value;
    const values = Array.from(ui.cat.options).map(o=>o.value);
    return values[Math.floor(Math.random()*values.length)];
  }

  function endMatch(){
    matchLocked = true;
    setLocked(true);
    setAdminActive(true);
    setAnswerVisible(true);
    clearInterval(timerInterval);

    let msg = "ü§ù Tie game!";
    if (scores.p1 > scores.p2) msg = `üèÜ ${names.p1} wins!`;
    if (scores.p2 > scores.p1) msg = `üèÜ ${names.p2} wins!`;

    ui.tag.textContent = "MATCH OVER";
    ui.q.textContent = msg;
    ui.ans.textContent = "Tap Reset to play again.";
    ui.timer.style.width = "0%";
    toast("Match finished");
  }

  function checkBest10Gate(){
    if (!settings.best10) return true;
    if (matchLocked) return false;

    if (!suddenDeath && matchQCount >= 10){
      if (scores.p1 === scores.p2){
        suddenDeath = true;
        toast("Sudden death!");
        return true;
      }
      endMatch();
      return false;
    }
    return true;
  }

  function getQuestionForTopic(topic){
    // Alina special: ensure we have at least some queue; refill until valid if needed
    if (topic === "alina"){
      const qObj = pickFromTopic("alina");
      if (qObj) return qObj;

      // Refill-until-valid: try to fetch more a few times quickly
      (async()=>{ await ensureAlinaPrefetchTargets(); })();

      return null;
    }

    if (topic === "custom"){
      return pickFromTopic("custom");
    }

    let qObj = pickFromTopic(topic);
    if (!qObj && topic !== "mixed"){
      qObj = pickFromTopic("mixed");
    }
    if (!qObj){
      qObj = pickFromTopic("custom");
    }
    return qObj;
  }

  function nextQuestion(){
    if (!checkBest10Gate()) return;

    const topic = currentTopic();

    // For OpenTDB categories, prefetch the selected topic
    if (topic !== "custom" && topic !== "alina"){
      fetchBatchOpenTDBFor(topic).catch(()=>{});
    }
    // For Alina, ensure background targets (fast-start will also be running)
    if (topic === "alina"){
      ensureAlinaPrefetchTargets().catch(()=>{});
    }

    resetUIForNext();

    let qObj = getQuestionForTopic(topic);

    if (!qObj){
      // Alina: if not enough queued yet, show a friendly loading message (fast start)
      if (topic === "alina"){
        const count = (banks.get("alina") || []).length;
        ui.tag.textContent = "ALINA";
        ui.q.textContent = count < ALINA_FAST_START_MIN
          ? `Loading Alina questions‚Ä¶ (${count}/${ALINA_FAST_START_MIN} to start)`
          : "Loading more Alina questions‚Ä¶";
        ui.ans.textContent = "Tap Next again in a moment.";
        setAnswerVisible(true);
        setLocked(true);
        setAdminActive(true);
        return;
      }

      ui.tag.textContent = (TOPIC_LABEL[topic] || "DONE").toUpperCase();
      ui.q.textContent = "You‚Äôve exhausted all unique questions for this category on this device.";
      ui.ans.textContent = "To replay questions, you‚Äôd need to clear site data (localStorage).";
      setAnswerVisible(true);
      setLocked(true);
      setAdminActive(true);
      return;
    }

    if (settings.best10 && !suddenDeath){
      matchQCount++;
    }

    // Track Alina served count (for stage2 trigger)
    if (topic === "alina"){
      alinaServedCount++;
      if (!alinaStage2Started && alinaServedCount >= ALINA_STAGE2_TRIGGER_AT){
        alinaStage2Started = true;
      }
    }

    ui.modeText.textContent = modeLine();
    const diffLabel = (topic === "alina") ? "EASY" : (settings.difficulty || "medium").toUpperCase();
    ui.subText.textContent = `${TOPIC_LABEL[topic] || topic} ‚Ä¢ ${diffLabel}`;

    renderQuestion(qObj);

    if (settings.lightning){
      startLightningIfNeeded();
    } else {
      startTimer();
    }
  }

  function showAnswer(){
    if (!currentQ) return;
    setAnswerVisible(true);
    revealCorrectOption();
  }

  function handleBuzz(player){
    if (paused || settings.lightning) return;
    if (!currentQ) return;
    if (buzzWinner !== 0) return;
    if (ui.controls.classList.contains("locked")) return;

    buzzWinner = player;

    sfxBuzz();
    clearInterval(timerInterval);

    setLocked(true);
    setAdminActive(true);

    if (player === 1) ui.b1.classList.add("winner");
    else ui.b2.classList.add("winner");

    toast(`${player === 1 ? names.p1 : names.p2} buzzed!`);
  }

  function pushUndo(){
    undoStack.push({
      scores: { ...scores },
      matchQCount,
      suddenDeath,
      matchLocked,
      settings: { ...settings },
      lightningTimeLeft,
      alinaServedCount,
      alinaStage2Started
    });
    if (undoStack.length > 20) undoStack.shift();
  }

  function undo(){
    const last = undoStack.pop();
    if (!last){ toast("Nothing to undo"); return; }
    scores = { ...last.scores };
    matchQCount = last.matchQCount;
    suddenDeath = last.suddenDeath;
    matchLocked = last.matchLocked;
    settings = { ...settings, ...last.settings };
    lightningTimeLeft = last.lightningTimeLeft;
    alinaServedCount = last.alinaServedCount;
    alinaStage2Started = last.alinaStage2Started;

    updateScores();
    ui.modeText.textContent = modeLine();
    applySettingsUI();
    toast("Undone");
  }

  function markCorrect(){
    if (!currentQ) return;
    pushUndo();

    if (!settings.lightning && buzzWinner === 0){
      toast("No buzz ‚Äî no point");
      sfxWrong();
      return;
    }

    if (buzzWinner === 1) scores.p1++;
    else if (buzzWinner === 2) scores.p2++;

    updateScores();

    ui.ans.style.background = "#2ecc71";
    sfxCorrect();
    toast("+1");

    if (settings.best10 && suddenDeath && scores.p1 !== scores.p2){
      endMatch();
      return;
    }

    setTimeout(()=> ui.ans.style.background = "var(--good)", 420);
  }

  function enableStealForOtherPlayer(){
    if (!settings.steal) return;

    const other = (buzzWinner === 1) ? 2 : (buzzWinner === 2 ? 1 : 0);
    if (!other) return;

    setLocked(false);
    ui.b1.style.pointerEvents = (other === 1) ? "auto" : "none";
    ui.b2.style.pointerEvents = (other === 2) ? "auto" : "none";
    ui.b1.style.opacity = (other === 1) ? "1" : "0.35";
    ui.b2.style.opacity = (other === 2) ? "1" : "0.35";

    toast(`Steal available: ${other === 1 ? names.p1 : names.p2}`);
  }

  function resetBuzzerInteractivity(){
    ui.b1.style.pointerEvents = "auto";
    ui.b2.style.pointerEvents = "auto";
    ui.b1.style.opacity = "";
    ui.b2.style.opacity = "";
  }

  function markWrong(){
    if (!currentQ) return;
    pushUndo();

    ui.ans.style.background = "#e74c3c";
    sfxWrong();
    toast("Wrong");

    if (!settings.lightning && settings.steal && buzzWinner !== 0){
      enableStealForOtherPlayer();
    }

    setTimeout(()=> ui.ans.style.background = "var(--good)", 420);
  }

  function togglePause(){
    if (!currentQ && !settings.lightning){
      toast("Start a question first");
      return;
    }
    paused = !paused;
    ui.pause.textContent = paused ? "Resume" : "Pause";

    if (paused){
      setLocked(true);
      setAdminActive(true);
      toast("Paused");
    } else {
      if (!settings.lightning){
        if (buzzWinner === 0 && timeLeft > 0){
          setLocked(false);
        }
      }
      toast("Resumed");
    }
  }

  /* -------------------- LIGHTNING -------------------- */
  function startLightningIfNeeded(){
    if (!settings.lightning) return;

    ui.modeText.textContent = modeLine();

    if (lightningInterval) return;

    lightningTimeLeft = Math.max(1, lightningTimeLeft);

    lightningInterval = setInterval(() => {
      if (paused) return;
      lightningTimeLeft -= 1;
      if (lightningTimeLeft < 0) lightningTimeLeft = 0;
      ui.modeText.textContent = modeLine();

      if (lightningTimeLeft <= 0){
        clearInterval(lightningInterval);
        lightningInterval = null;
        settings.lightning = false;
        saveSettings();
        applySettingsUI();

        toast("Lightning over!");
        ui.modeText.textContent = modeLine();
        setLocked(true);
        setAdminActive(true);
      }
    }, 1000);
  }

  function stopLightning(){
    if (lightningInterval){
      clearInterval(lightningInterval);
      lightningInterval = null;
    }
    lightningTimeLeft = LIGHTNING_SECONDS;
  }

  /* -------------------- SETTINGS SHEET -------------------- */
  function openSheet(){
    ui.sheetOverlay.style.display = "flex";
    ui.sheetOverlay.setAttribute("aria-hidden", "false");
  }
  function closeSheet(){
    ui.sheetOverlay.style.display = "none";
    ui.sheetOverlay.setAttribute("aria-hidden", "true");
  }

  function editNames(){
    const p1 = prompt("Player 1 name:", names.p1);
    if (p1 === null) return;
    const p2 = prompt("Player 2 name:", names.p2);
    if (p2 === null) return;
    names.p1 = (p1.trim() || "Player 1");
    names.p2 = (p2.trim() || "Player 2");
    saveNames();
    applyNames();
    toast("Names updated");
  }

  /* -------------------- RESET -------------------- */
  function resetAll(){
    clearInterval(timerInterval);
    resetBuzzerInteractivity();

    paused = false;
    ui.pause.textContent = "Pause";

    scores = { p1:0, p2:0 };
    updateScores();

    matchQCount = 0;
    suddenDeath = false;
    matchLocked = false;

    stopLightning();
    settings.lightning = false;
    saveSettings();
    applySettingsUI();

    undoStack.length = 0;

    alinaServedCount = 0;
    alinaStage2Started = false;

    ui.modeText.textContent = "READY";
    ui.subText.textContent = apiToken ? "Online ready ‚Ä¢ Loading more‚Ä¶" : "Offline mode (custom only)";

    ui.tag.textContent = "CUSTOM";
    ui.q.textContent = 'Tap ‚ÄúNext ‚Üí‚Äù to start!';
    ui.ans.textContent = "ANSWER HIDDEN";
    setAnswerVisible(false);
    ui.timer.style.width = "100%";

    resetWinnerState();
    clearOptions();
    setLocked(false);
    setAdminActive(true);

    for (const topic of banks.keys()) resetDeck(topic);

    toast("Reset");
  }

  /* -------------------- EVENT WIRING -------------------- */
  ui.cat.addEventListener("change", () => {
    toast(`Category set: ${TOPIC_LABEL[ui.cat.value] || ui.cat.value}`);
    // If user switches to Alina, give a quick status
    if (ui.cat.value === "alina"){
      const count = (banks.get("alina") || []).length;
      ui.subText.textContent = `Alina loading‚Ä¶ ${count}/${ALINA_STAGE1_TARGET}`;
      // kick prefetch immediately
      ensureAlinaPrefetchTargets().catch(()=>{});
    }
  });

  ui.b1.addEventListener("click", () => handleBuzz(1));
  ui.b2.addEventListener("click", () => handleBuzz(2));

  ui.show.addEventListener("click", showAnswer);
  ui.correct.addEventListener("click", () => { markCorrect(); });
  ui.wrong.addEventListener("click", () => { markWrong(); });

  ui.next.addEventListener("click", () => {
    resetBuzzerInteractivity();
    nextQuestion();
  });

  ui.undo.addEventListener("click", undo);
  ui.pause.addEventListener("click", togglePause);
  ui.reset.addEventListener("click", resetAll);

  ui.settingsBtn.addEventListener("click", openSheet);
  ui.sheetClose.addEventListener("click", closeSheet);
  ui.sheetOverlay.addEventListener("click", (e) => {
    if (e.target === ui.sheetOverlay) closeSheet();
  });

  ui.sfxChip.addEventListener("click", () => {
    settings.sfx = !settings.sfx;
    saveSettings(); applySettingsUI();
    toast(`SFX ${settings.sfx ? "ON" : "OFF"}`);
  });

  ui.diffSel.addEventListener("change", () => {
    settings.difficulty = ui.diffSel.value || "medium";
    saveSettings(); applySettingsUI();
    toast(`Difficulty: ${settings.difficulty}`);
    // proactively fetch for selected category with new difficulty (not Alina)
    if (ui.cat.value !== "alina"){
      fetchBatchOpenTDBFor(ui.cat.value).catch(()=>{});
    }
  });

  ui.randomChip.addEventListener("click", () => {
    settings.randomCategory = !settings.randomCategory;
    saveSettings(); applySettingsUI();
    toast(`Random ${settings.randomCategory ? "ON" : "OFF"}`);
  });

  ui.best10Chip.addEventListener("click", () => {
    settings.best10 = !settings.best10;
    matchQCount = 0;
    suddenDeath = false;
    matchLocked = false;

    saveSettings(); applySettingsUI();
    ui.modeText.textContent = modeLine();
    toast(`Best of 10 ${settings.best10 ? "ON" : "OFF"}`);
  });

  ui.stealChip.addEventListener("click", () => {
    settings.steal = !settings.steal;
    saveSettings(); applySettingsUI();
    toast(`Steal ${settings.steal ? "ON" : "OFF"}`);
  });

  ui.lightChip.addEventListener("click", () => {
    settings.lightning = !settings.lightning;
    if (settings.lightning){
      lightningTimeLeft = LIGHTNING_SECONDS;
      toast("Lightning ON");
    } else {
      stopLightning();
      toast("Lightning OFF");
    }
    saveSettings(); applySettingsUI();
    ui.modeText.textContent = modeLine();
  });

  ui.nerdChip.addEventListener("click", () => {
    settings.nerd = !settings.nerd;
    saveSettings(); applySettingsUI();
    toast(`Nerd Mode ${settings.nerd ? "ON" : "OFF"}`);
    fetchBatchOpenTDBFor("mixed").catch(()=>{});
  });

  ui.namesChip.addEventListener("click", () => editNames());

  /* -------------------- INIT -------------------- */
  function initBanks(){
    const topics = ["mixed","custom","alina","tv","movies","music","science","history","computers","pop","80s","90s","2000s","disney","ww2"];
    topics.forEach(ensureTopic);

    addToBank("custom", CUSTOM);
    addToBank("mixed", CUSTOM);

    addToBank("pop", CUSTOM.filter(x => x.cat === "Pop Culture"));
    addToBank("80s", CUSTOM.filter(x => x.cat === "1980s"));
    addToBank("90s", CUSTOM.filter(x => x.cat === "1990s"));
    addToBank("2000s", CUSTOM.filter(x => x.cat === "2000s"));
    addToBank("disney", CUSTOM.filter(x => x.cat === "Disney"));
    addToBank("ww2", CUSTOM.filter(x => x.cat === "World War 2"));

    topics.forEach(resetDeck);
  }

  async function init(){
    loadSeen();
    loadNames();
    loadSettings();

    applyNames();
    applySettingsUI();
    updateScores();

    ui.q.textContent = 'Tap ‚ÄúNext ‚Üí‚Äù to start!';
    ui.tag.textContent = "CUSTOM";
    ui.ans.textContent = "ANSWER HIDDEN";
    setAnswerVisible(false);

    setAdminActive(true);
    setLocked(false);

    initBanks();

    // Start Alina fast-start loader (does NOT block gameplay)
    setTimeout(() => alinaFastStartLoop(), 200);

    setLoading(true, "READY", "Connecting‚Ä¶");
    apiToken = await getToken();

    if (!apiToken){
      setLoading(false, "READY", "Offline mode (custom only) ‚Ä¢ Alina requires internet");
      return;
    }

    setLoading(true, "READY", "Warming up‚Ä¶");
    await warmupOpenTDB();
    setLoading(false, "READY", "Online ready ‚Ä¢ Loading more‚Ä¶");

    setTimeout(() => backgroundFillOpenTDB(), 600);
  }

  init();
})();
</script>
</body>
</html>