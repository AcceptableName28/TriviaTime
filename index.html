<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Trivia Ultimate</title>

  <style>
    :root{
      --p1-color:#8e44ad;
      --p2-color:#2980b9;
      --bg:#2c3e50;
      --card:#ecf0f1;
      --accent:#f1c40f;
      --text:#14212c;
      --muted: rgba(255,255,255,0.14);
    }

    *{box-sizing:border-box; touch-action: manipulation;}

    /* iPhone safe areas + true on-screen fit */
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);

      /* Fit within Safari UI + notch/home bar */
      height: 100svh;
      height: 100dvh;
      overflow:hidden;

      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);

      display:flex;
      justify-content:center;
    }

    .game-container{
      width:100%;
      max-width:600px;

      /* use the remaining padded area */
      height:100%;
      min-height:0;

      display:grid;

      /* SHORTER header + SHORTER controls so everything fits */
      grid-template-rows: 46px 1fr 206px;
    }

    /* HEADER (smaller) */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      background: rgba(0,0,0,0.22);
      color:#fff;
    }

    .score-box{
      min-width:64px;
      text-align:center;
      line-height:1;
    }

    .score-val{
      font-size:1.35rem;
      font-weight:950;
      line-height:1;
    }

    .score-name{
      margin-top:2px;
      font-size:0.62rem;
      font-weight:900;
      letter-spacing:0.8px;
      opacity:0.9;
      text-transform:uppercase;
    }

    .center-info{
      text-align:center;
      line-height:1.05;
      width:56%;
      max-width:310px;
      padding:0 6px;
    }

    #mode-text{
      font-size:0.74rem;
      font-weight:950;
    }

    #sub-text{
      font-size:0.62rem;
      opacity:0.75;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .loader{
      border: 3px solid rgba(255,255,255,0.2);
      border-top: 3px solid var(--accent);
      border-radius:50%;
      width:14px; height:14px;
      animation:spin 1s linear infinite;
      display:none;
      margin:4px auto 0;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* CARD AREA (more outer padding so it looks centered + not edge-to-edge) */
    .card-area{
      padding:10px 12px 8px;
      min-height:0;
      display:flex;
      align-items:stretch;
    }

    .card{
      width:100%;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 10px 22px rgba(0,0,0,0.28);

      /* smaller padding = smaller board */
      padding:10px 10px 10px;

      display:flex;
      flex-direction:column;
      gap:8px;

      min-height:0;
      overflow:hidden; /* keep the page from scrolling */
      position:relative;
    }

    .timer-track{
      position:absolute;
      top:0; left:0;
      width:100%;
      height:6px;
      background:rgba(0,0,0,0.08);
    }
    .timer-fill{
      height:100%;
      width:100%;
      background:var(--accent);
      transition:width 0.1s linear;
    }

    .category-tag{
      align-self:center;
      margin-top:8px;
      background:#95a5a6;
      color:#fff;
      padding:4px 10px;
      border-radius:999px;
      font-size:0.64rem;
      font-weight:950;
      text-transform:uppercase;
    }

    /* Smaller question font */
    .question-text{
      font-size:1.02rem;
      font-weight:950;
      line-height:1.18;
      margin:0;
      padding:0 4px;
      text-align:center;

      /* prevent big vertical growth */
      max-height: 5.2em; /* ~4-5 lines */
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Multiple choice area: scroll INSIDE the card only */
    .options-wrap{
      display:none;
      width:100%;
      gap:7px;
      flex-direction:column;

      max-height: 170px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right:2px;
    }

    .option-btn{
      border:none;
      border-radius:12px;
      padding:9px 10px;
      background: rgba(44,62,80,0.10);
      color:#14212c;
      font-weight:900;
      font-size:0.86rem;
      text-align:left;
      box-shadow:0 2px 0 rgba(0,0,0,0.08);
    }
    .option-btn:active{transform: translateY(2px);}

    .opt-label{
      display:inline-block;
      min-width:24px;
      font-weight:950;
      opacity:0.85;
    }

    .option-btn.locked{
      background: rgba(241,196,15,0.24);
      box-shadow: 0 0 0 2px rgba(241,196,15,0.52) inset;
    }
    .option-btn.correct{
      background: rgba(46,204,113,0.24);
      box-shadow: 0 0 0 2px rgba(46,204,113,0.52) inset;
    }

    /* Answer box: compact */
    .answer-box{
      background:#27ae60;
      color:#fff;
      padding:9px 10px;
      border-radius:12px;
      width:100%;
      font-size:0.92rem;
      font-weight:950;

      opacity:0;
      transition:opacity 0.25s;

      min-height:38px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;

      /* if long answer, scroll inside */
      max-height: 3.8em;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .answer-box.visible{opacity:1;}

    /* CONTROLS (compact so entire UI fits) */
    .controls-area{
      background: rgba(0,0,0,0.30);
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:7px;
      min-height:0;
    }

    .row{
      display:flex;
      gap:8px;
      width:100%;
      flex-wrap:wrap;
    }

    select, button{
      border:none;
      border-radius:10px;
      font-weight:950;
      -webkit-tap-highlight-color: transparent;
    }

    .select{
      height:34px;
      background:var(--muted);
      color:#fff;
      padding:0 10px;
      flex: 1 1 160px;
      appearance:none;
      -webkit-appearance:none;
      font-size:0.74rem;
    }

    .btn{
      height:34px;
      background:var(--muted);
      color:#fff;
      padding:0 10px;
      font-size:0.74rem;
      flex: 1 1 110px;
    }

    .btn.on{background: rgba(241,196,15,0.70); color:#14212c;}
    .btn.small{flex: 1 1 96px;}
    .btn.tiny{flex: 1 1 88px;}

    /* Buzzers smaller */
    .buzzer-row{display:flex; gap:10px;}
    .buzzer{
      flex:1;
      height:44px;
      color:#fff;
      font-size:1.00rem;
      font-weight:1000;
      text-transform:uppercase;
      border-radius:12px;
      box-shadow:0 3px 0 rgba(0,0,0,0.22);
    }
    .buzzer:active{transform: translateY(3px); box-shadow:none;}
    .b1{background:var(--p1-color);}
    .b2{background:var(--p2-color);}

    .controls-area.locked .buzzer{opacity:0.35; pointer-events:none;}
    .controls-area.locked .buzzer.winner{opacity:1; box-shadow:0 0 12px rgba(255,255,255,0.7);}

    /* Admin buttons smaller */
    .admin-row{
      display:flex;
      gap:8px;
      opacity:0.3;
      pointer-events:none;
    }
    .controls-area.active-admin .admin-row{opacity:1; pointer-events:all;}

    .admin{
      flex:1;
      height:36px;
      font-size:0.78rem;
      font-weight:1000;
      border-radius:10px;
      color:#fff;
    }
    .show{background:#f39c12; color:#14212c;}
    .correct{background:#27ae60;}
    .wrong{background:#c0392b;}
    .next{background:#7f8c8d;}

    /* Meta row smaller */
    .meta-row{display:flex; gap:8px;}
    .meta{
      flex:1;
      height:34px;
      font-size:0.74rem;
      font-weight:1000;
      border-radius:10px;
      color:#fff;
      background: rgba(255,255,255,0.14);
    }
    .danger{background: rgba(231,76,60,0.65);}
    .pause{background: rgba(52,152,219,0.55); color:#122231;}
    .good{background: rgba(46,204,113,0.55); color:#122231;}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(12px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,0.86);
      color:#fff;
      padding:9px 10px;
      border-radius:12px;
      font-weight:950;
      font-size:0.82rem;
      display:none;
      max-width:92vw;
      text-align:center;
      z-index:9999;
    }

    /* Lightning overlay */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:18px;
    }
    .overlay-card{
      width:min(520px, 94vw);
      background:#fff;
      border-radius:16px;
      padding:14px;
      box-shadow:0 18px 45px rgba(0,0,0,0.35);
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .overlay-title{font-weight:1000; font-size:0.98rem; color:#14212c;}
    .overlay-sub{font-weight:900; font-size:0.82rem; opacity:0.75;}
    .overlay-row{display:flex; gap:10px;}
    .overlay-btn{
      flex:1;
      border:none;
      border-radius:12px;
      padding:12px 10px;
      font-weight:1000;
      font-size:0.92rem;
      color:#fff;
      box-shadow:0 4px 0 rgba(0,0,0,0.18);
    }
    .overlay-btn:active{transform: translateY(3px); box-shadow:none;}
    .overlay-p1{background:var(--p1-color);}
    .overlay-p2{background:var(--p2-color);}
    .overlay-none{background:#7f8c8d;}
  </style>
</head>

<body>
  <div class="game-container">
    <div class="header">
      <div class="score-box">
        <div class="score-val" id="score-p1">0</div>
        <div class="score-name" id="name-p1" style="color:#d2b4de">PAULINE</div>
      </div>

      <div class="center-info">
        <div id="mode-text">READY</div>
        <div id="sub-text">Loading‚Ä¶</div>
        <div class="loader" id="loader"></div>
      </div>

      <div class="score-box">
        <div class="score-val" id="score-p2">0</div>
        <div class="score-name" id="name-p2" style="color:#a9cce3">JON</div>
      </div>
    </div>

    <div class="card-area">
      <div class="card" id="card">
        <div class="timer-track"><div class="timer-fill" id="timer"></div></div>
        <div class="category-tag" id="category">CUSTOM</div>
        <p class="question-text" id="question">Tap ‚ÄúNext ‚Üí‚Äù to start!</p>
        <div class="options-wrap" id="options"></div>
        <div class="answer-box" id="answer">ANSWER HIDDEN</div>
      </div>
    </div>

    <div class="controls-area" id="controls">
      <div class="row">
        <select class="select" id="categorySelect" aria-label="Category">
          <option value="mixed" selected>MIXED</option>
          <option value="custom">CUSTOM (Friends/HIMYM/Star Wars/90s)</option>
          <option value="pop">POP CULTURE</option>
          <option value="80s">1980s</option>
          <option value="90s">1990s</option>
          <option value="2000s">2000s</option>
          <option value="disney">DISNEY</option>
          <option value="ww2">WORLD WAR 2</option>
          <option value="tv">TV</option>
          <option value="movies">MOVIES</option>
          <option value="music">MUSIC</option>
          <option value="science">SCIENCE</option>
          <option value="history">HISTORY</option>
          <option value="computers">COMPUTERS</option>
        </select>

        <button class="btn small" id="randomBtn">RANDOM: OFF</button>
        <button class="btn tiny" id="best10Btn">BEST10</button>
        <button class="btn tiny" id="lightningBtn">LIGHTNING</button>
        <button class="btn tiny" id="namesBtn">NAMES</button>
      </div>

      <div class="row">
        <button class="btn" id="stealBtn">STEAL: OFF</button>

        <select class="select" id="difficultySelect" aria-label="Difficulty">
          <option value="easy">DIFFICULTY: EASY</option>
          <option value="medium" selected>DIFFICULTY: MEDIUM</option>
          <option value="hard">DIFFICULTY: HARD</option>
        </select>

        <button class="btn" id="sfxBtn">SFX: ON</button>
      </div>

      <div class="buzzer-row">
        <button class="buzzer b1" id="b1">PAULINE</button>
        <button class="buzzer b2" id="b2">JON</button>
      </div>

      <div class="admin-row" id="adminRow">
        <button class="admin show" id="showBtn">Show Answer</button>
        <button class="admin correct" id="correctBtn">Correct (+1)</button>
        <button class="admin wrong" id="wrongBtn">Wrong (0)</button>
        <button class="admin next" id="nextBtn">Next ‚Üí</button>
      </div>

      <div class="meta-row">
        <button class="meta danger" id="undoBtn">Undo</button>
        <button class="meta pause" id="pauseBtn">Pause</button>
        <button class="meta good" id="resetBtn">Reset</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="overlay" id="overlay">
    <div class="overlay-card">
      <div class="overlay-title" id="overlayTitle">Who answered?</div>
      <div class="overlay-sub" id="overlaySub">Tap the winner (or No Score)</div>
      <div class="overlay-row">
        <button class="overlay-btn overlay-p1" id="overlayP1">Player 1</button>
        <button class="overlay-btn overlay-p2" id="overlayP2">Player 2</button>
      </div>
      <div class="overlay-row">
        <button class="overlay-btn overlay-none" id="overlayNone">No Score</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const QUESTION_SECONDS = 30;
  const TICK_MS = 100;
  const BEST10_MAX_Q = 10;

  const LIGHTNING_SECONDS = 60;

  const API_TIMEOUT_MS = 7000;
  const API_BATCH_SIZE = 30;
  const FAST_WARMUP_BATCHES = 2;

  const NAME_KEY = "trivia_names_v3";

  const ui = {
    score1: document.getElementById("score-p1"),
    score2: document.getElementById("score-p2"),
    name1: document.getElementById("name-p1"),
    name2: document.getElementById("name-p2"),
    modeText: document.getElementById("mode-text"),
    subText: document.getElementById("sub-text"),
    loader: document.getElementById("loader"),

    cat: document.getElementById("category"),
    q: document.getElementById("question"),
    options: document.getElementById("options"),
    a: document.getElementById("answer"),
    timer: document.getElementById("timer"),

    controls: document.getElementById("controls"),
    adminRow: document.getElementById("adminRow"),

    categorySelect: document.getElementById("categorySelect"),
    randomBtn: document.getElementById("randomBtn"),
    best10Btn: document.getElementById("best10Btn"),
    lightningBtn: document.getElementById("lightningBtn"),
    namesBtn: document.getElementById("namesBtn"),
    stealBtn: document.getElementById("stealBtn"),
    difficultySelect: document.getElementById("difficultySelect"),
    sfxBtn: document.getElementById("sfxBtn"),

    b1: document.getElementById("b1"),
    b2: document.getElementById("b2"),

    showBtn: document.getElementById("showBtn"),
    correctBtn: document.getElementById("correctBtn"),
    wrongBtn: document.getElementById("wrongBtn"),
    nextBtn: document.getElementById("nextBtn"),

    undoBtn: document.getElementById("undoBtn"),
    pauseBtn: document.getElementById("pauseBtn"),
    resetBtn: document.getElementById("resetBtn"),

    toast: document.getElementById("toast"),

    overlay: document.getElementById("overlay"),
    overlayTitle: document.getElementById("overlayTitle"),
    overlaySub: document.getElementById("overlaySub"),
    overlayP1: document.getElementById("overlayP1"),
    overlayP2: document.getElementById("overlayP2"),
    overlayNone: document.getElementById("overlayNone")
  };

  let names = { p1:"Pauline", p2:"Jon" };
  let apiToken = null;

  let p1Score = 0;
  let p2Score = 0;

  let currentQ = null;
  let buzzWinner = 0;
  let lockedGuessIndex = null;

  let timerInterval = null;
  let timeLeft = QUESTION_SECONDS;
  let paused = false;

  let randomCategory = false;
  let stealMode = false;
  let sfxOn = true;

  let best10Enabled = false;
  let matchQCount = 0;
  let matchLocked = false;
  let suddenDeath = false;

  let lightningEnabled = false;
  let lightningTimeLeft = LIGHTNING_SECONDS;
  let lightningInterval = null;

  let lightningPendingCorrect = null;

  const undoStack = [];
  const playedKeys = new Set();

  const banks = new Map();
  const bankKeys = new Map();
  const working = new Map();

  let stealAvailable = false;
  let stealPlayer = 0;

  const CUSTOM_PACK = {
    base: [
      {cat:"Friends", q:"In FRIENDS, what is the name of Joey's bedtime penguin?", a:"Hugsy"},
      {cat:"Friends", q:"In FRIENDS, what name does Phoebe often use as her alter ego?", a:"Regina Phalange"},
      {cat:"Friends", q:"In FRIENDS, what is Chandler Bing's middle name?", a:"Muriel"},
      {cat:"Friends", q:"In FRIENDS, what color is Monica and Rachel‚Äôs apartment door?", a:"Purple"},
      {cat:"HIMYM", q:"In How I Met Your Mother, where does the gang frequently hang out?", a:"MacLaren's Pub"},
      {cat:"HIMYM", q:"In How I Met Your Mother, what color is the French horn Ted steals for Robin?", a:"Blue"},
      {cat:"Star Wars", q:"In Star Wars, what species is Admiral Ackbar?", a:"Mon Calamari"},
      {cat:"Star Wars", q:"In Star Wars, what is the name of Han Solo‚Äôs ship?", a:"The Millennium Falcon"},
      {cat:"90s", q:"In 'Kenan & Kel', who is obsessed with orange soda?", a:"Kel"},
      {cat:"90s", q:"Which 90s toy was a furry electronic pet that spoke ‚ÄúFurbish‚Äù?", a:"Furby"}
    ],
    pop: [
      {cat:"Pop Culture", q:"What is the name of the coffee shop in FRIENDS?", a:"Central Perk"},
      {cat:"Pop Culture", q:"In The Office (US), what paper company do they work for?", a:"Dunder Mifflin"},
      {cat:"Pop Culture", q:"In Marvel, what is Captain America‚Äôs shield made of?", a:"Vibranium"},
      {cat:"Pop Culture", q:"In Stranger Things, what is Eleven‚Äôs favorite snack?", a:"Eggo waffles"}
    ],
    disney: [
      {cat:"Disney", q:"In The Lion King, what is Simba‚Äôs father‚Äôs name?", a:"Mufasa"},
      {cat:"Disney", q:"In Frozen, what is the name of the snowman?", a:"Olaf"},
      {cat:"Disney", q:"In Aladdin, what is the name of Aladdin‚Äôs monkey?", a:"Abu"}
    ],
    y80s: [
      {cat:"1980s", q:"What arcade character eats dots and avoids ghosts?", a:"Pac-Man"},
      {cat:"1980s", q:"Which sci-fi movie features the DeLorean time machine?", a:"Back to the Future"},
      {cat:"1980s", q:"Which band sang ‚ÄúTake On Me‚Äù?", a:"a-ha"}
    ],
    y90s: [
      {cat:"1990s", q:"In The Fresh Prince of Bel-Air, what neighborhood does Will move to?", a:"Bel-Air"},
      {cat:"1990s", q:"What is the name of the 90s handheld virtual pet?", a:"Tamagotchi"},
      {cat:"1990s", q:"What TV show features the tagline ‚ÄúThe Truth Is Out There‚Äù?", a:"The X-Files"}
    ],
    y2000s: [
      {cat:"2000s", q:"What video platform launched in 2005?", a:"YouTube"},
      {cat:"2000s", q:"What company launched the iPhone in 2007?", a:"Apple"}
    ],
    ww2: [
      {cat:"World War 2", q:"What day is commonly known as the attack on Pearl Harbor?", a:"December 7, 1941"},
      {cat:"World War 2", q:"What was the code name for the Allied invasion of Normandy?", a:"Operation Overlord"}
    ]
  };

  const ALL_CUSTOM = []
    .concat(CUSTOM_PACK.base, CUSTOM_PACK.pop, CUSTOM_PACK.disney, CUSTOM_PACK.y80s, CUSTOM_PACK.y90s, CUSTOM_PACK.y2000s, CUSTOM_PACK.ww2)
    .map(q => ({...q, type:"open"}));

  const OTD_CATS = { gen:9, movies:11, music:12, tv:14, science:17, computers:18, history:23 };

  function toast(msg){
    ui.toast.textContent = msg;
    ui.toast.style.display = "block";
    clearTimeout(ui.toast._t);
    ui.toast._t = setTimeout(()=> ui.toast.style.display="none", 1300);
  }

  function shuffle(arr){
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function decodeHtml(str){
    const t = document.createElement("textarea");
    t.innerHTML = str;
    return t.value;
  }

  function makeKey(qObj){
    const c=(qObj.cat||"").trim().toLowerCase();
    const q=(qObj.q||"").trim().toLowerCase();
    const a=(qObj.a||"").trim().toLowerCase();
    return `${c}||${q}||${a}`;
  }

  function ensureBank(topic){
    if (!banks.has(topic)) banks.set(topic, []);
    if (!bankKeys.has(topic)) bankKeys.set(topic, new Set());
  }

  function addToBank(topic, items){
    ensureBank(topic);
    const arr = banks.get(topic);
    const keys = bankKeys.get(topic);
    for (const item of items){
      const k = makeKey(item);
      if (!keys.has(k)){
        keys.add(k);
        arr.push(item);
      }
    }
  }

  function resetWorkingDeck(topic){
    const src = banks.get(topic) || [];
    working.set(topic, shuffle(src.slice()));
  }

  function pickFromDeck(topic){
    if (!working.has(topic)) resetWorkingDeck(topic);
    const deck = working.get(topic);

    while (deck.length){
      const qObj = deck.shift();
      const k = makeKey(qObj);
      if (playedKeys.has(k)) continue;
      playedKeys.add(k);
      return qObj;
    }
    resetWorkingDeck(topic);
    const d2 = working.get(topic);
    while (d2.length){
      const qObj = d2.shift();
      const k = makeKey(qObj);
      if (playedKeys.has(k)) continue;
      playedKeys.add(k);
      return qObj;
    }
    return null;
  }

  function fetchWithTimeout(url, ms){
    return new Promise((resolve,reject)=>{
      const controller = new AbortController();
      const t=setTimeout(()=>{ controller.abort(); reject(new Error("timeout")); }, ms);
      fetch(url, {cache:"no-store", signal:controller.signal})
        .then(r=>{ clearTimeout(t); resolve(r); })
        .catch(e=>{ clearTimeout(t); reject(e); });
    });
  }

  function setLoading(on, top, sub){
    ui.loader.style.display = on ? "block" : "none";
    if (top) ui.modeText.textContent = top;
    if (sub) ui.subText.textContent = sub;
  }

  function updateScores(){
    ui.score1.textContent = String(p1Score);
    ui.score2.textContent = String(p2Score);
  }

  function applyNames(){
    ui.name1.textContent = names.p1.toUpperCase();
    ui.name2.textContent = names.p2.toUpperCase();
    ui.b1.textContent = names.p1.toUpperCase();
    ui.b2.textContent = names.p2.toUpperCase();
    ui.overlayP1.textContent = names.p1;
    ui.overlayP2.textContent = names.p2;
    document.title = `${names.p1} vs ${names.p2}: Trivia`;
  }

  function loadNames(){
    try{
      const raw = localStorage.getItem(NAME_KEY);
      if (raw){
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed.p1 === "string" && typeof parsed.p2 === "string"){
          names = { p1: parsed.p1 || "Player 1", p2: parsed.p2 || "Player 2" };
        }
      }
    }catch(e){}
  }

  function saveNames(){
    try{ localStorage.setItem(NAME_KEY, JSON.stringify(names)); }catch(e){}
  }

  function best10Status(){
    if (!best10Enabled) return "READY";
    if (matchLocked) return "BEST OF 10 (FINISHED)";
    if (suddenDeath) return "SUDDEN DEATH";
    return `BEST OF 10 ‚Ä¢ Q ${matchQCount}/${BEST10_MAX_Q}`;
  }

  function getSelectedTopic(){
    if (!randomCategory) return ui.categorySelect.value;
    const values = Array.from(ui.categorySelect.options).map(o=>o.value);
    return values[Math.floor(Math.random()*values.length)];
  }

  function setAnswerVisible(on){
    if (on) ui.a.classList.add("visible");
    else ui.a.classList.remove("visible");
  }

  function setAdminActive(active){
    if (active) ui.controls.classList.add("active-admin");
    else ui.controls.classList.remove("active-admin");
  }

  function lockBuzzers(lock){
    if (lock) ui.controls.classList.add("locked");
    else ui.controls.classList.remove("locked");
  }

  function clearOptions(){
    ui.options.innerHTML = "";
    ui.options.style.display = "none";
  }

  function renderOptions(qObj){
    clearOptions();
    if (!qObj || qObj.type !== "mc" || !Array.isArray(qObj.options) || qObj.options.length !== 4) return;

    ui.options.style.display = "flex";
    const labels = ["A","B","C","D"];

    qObj.options.forEach((txt, i)=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "option-btn";
      btn.innerHTML = `<span class="opt-label">${labels[i]}.</span> ${txt}`;

      btn.addEventListener("click", ()=>{
        if (!lightningEnabled && buzzWinner === 0){
          toast("Buzz first to lock an answer");
          return;
        }

        lockedGuessIndex = i;
        ui.options.querySelectorAll(".option-btn").forEach(b=>b.classList.remove("locked"));
        btn.classList.add("locked");

        if (lightningEnabled){
          const correct = (currentQ.type === "mc" && i === currentQ.correctIndex);
          lightningPendingCorrect = correct;
          showLightningOverlay();
        } else {
          toast("Answer locked");
          if (navigator.vibrate) navigator.vibrate(15);
        }
      });

      ui.options.appendChild(btn);
    });
  }

  function revealCorrectOption(){
    if (!currentQ || currentQ.type !== "mc") return;
    const idx = currentQ.correctIndex;
    const buttons = Array.from(ui.options.querySelectorAll(".option-btn"));
    if (Number.isInteger(idx) && buttons[idx]) buttons[idx].classList.add("correct");
  }

  function haptic(){ try{ if (navigator.vibrate) navigator.vibrate(20); }catch(e){} }
  function beep(freq=440, ms=80){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;
      const ctx = new AudioCtx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.value = freq;
      g.gain.value = 0.05;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, ms);
    }catch(e){}
  }
  function sfxBuzz(){ if (!sfxOn) return; haptic(); beep(520, 80); }
  function sfxCorrect(){ if (!sfxOn) return; haptic(); beep(780, 60); setTimeout(()=>beep(980, 60), 80); }
  function sfxWrong(){ if (!sfxOn) return; haptic(); beep(220, 110); }

  async function getToken(){
    try{
      const r = await fetchWithTimeout("https://opentdb.com/api_token.php?command=request", API_TIMEOUT_MS);
      const d = await r.json();
      if (d.response_code === 0) return d.token;
    }catch(e){}
    return null;
  }

  function buildApiMC(item){
    const q = decodeHtml(item.question);
    const correct = decodeHtml(item.correct_answer);
    const incorrect = (item.incorrect_answers || []).map(decodeHtml);
    const all = shuffle([correct, ...incorrect]);
    const correctIndex = all.indexOf(correct);
    return {
      cat: decodeHtml(item.category || "Trivia"),
      q,
      a: correct,
      type: "mc",
      options: all,
      correctIndex
    };
  }

  async function fetchBatch(categoryId, difficulty){
    let url = `https://opentdb.com/api.php?amount=${API_BATCH_SIZE}&type=multiple`;
    if (categoryId) url += `&category=${categoryId}`;
    if (difficulty) url += `&difficulty=${difficulty}`;
    if (apiToken) url += `&token=${apiToken}`;

    const res = await fetchWithTimeout(url, API_TIMEOUT_MS);
    const data = await res.json();

    if (!data.results || !data.results.length) return [];
    return data.results.map(buildApiMC);
  }

  function topicToFetchPlan(topic){
    switch(topic){
      case "tv": return [{catId: OTD_CATS.tv, w: 1}];
      case "movies": return [{catId: OTD_CATS.movies, w: 1}];
      case "music": return [{catId: OTD_CATS.music, w: 1}];
      case "science": return [{catId: OTD_CATS.science, w: 1}];
      case "history": return [{catId: OTD_CATS.history, w: 1}];
      case "computers": return [{catId: OTD_CATS.computers, w: 1}];
      case "ww2": return [{catId: OTD_CATS.history, w: 1}];
      case "disney": return [{catId: OTD_CATS.movies, w: 2},{catId: OTD_CATS.gen, w:1}];
      case "80s":
      case "90s":
      case "2000s":
        return [{catId: OTD_CATS.music, w:2},{catId: OTD_CATS.tv, w:1},{catId: OTD_CATS.movies, w:1},{catId: OTD_CATS.gen, w:1}];
      case "pop":
        return [{catId: OTD_CATS.tv, w:2},{catId: OTD_CATS.movies, w:2},{catId: OTD_CATS.music, w:1},{catId: OTD_CATS.gen, w:1}];
      case "mixed":
      default:
        return [
          {catId: OTD_CATS.gen, w:1},
          {catId: OTD_CATS.tv, w:1},
          {catId: OTD_CATS.movies, w:1},
          {catId: OTD_CATS.music, w:1},
          {catId: OTD_CATS.science, w:1},
          {catId: OTD_CATS.history, w:1},
          {catId: OTD_CATS.computers, w:1},
        ];
    }
  }

  function pickWeighted(plan){
    const total = plan.reduce((s,x)=>s+x.w,0);
    let r = Math.random() * total;
    for (const item of plan){
      r -= item.w;
      if (r <= 0) return item.catId;
    }
    return plan[0].catId;
  }

  async function warmupOnlineBanks(){
    if (!apiToken) return;

    const topics = ["mixed","tv","movies","music","science","history","computers","pop","80s","90s","2000s","disney","ww2"];
    topics.forEach(ensureBank);

    for (let i=0; i<FAST_WARMUP_BATCHES; i++){
      const diff = ui.difficultySelect.value;
      for (const topic of topics){
        const plan = topicToFetchPlan(topic);
        const catId = pickWeighted(plan);

        setLoading(true, "READY", `Fetching‚Ä¶ ${topic.toUpperCase()}`);
        try{
          const items = await fetchBatch(catId, diff);
          addToBank(topic, items);
          if (topic !== "mixed") addToBank("mixed", items);
        }catch(e){}
      }
    }

    setLoading(false, best10Status(), "Online ready ‚Ä¢ Loading more‚Ä¶");
    topics.forEach(resetWorkingDeck);
  }

  async function backgroundFillLoop(){
    if (!apiToken) return;

    const topics = ["mixed","tv","movies","music","science","history","computers","pop","80s","90s","2000s","disney","ww2"];

    while(true){
      const diff = ui.difficultySelect.value;
      for (const topic of topics){
        ensureBank(topic);
        const size = (banks.get(topic) || []).length;

        if (size < 220){
          const plan = topicToFetchPlan(topic);
          const catId = pickWeighted(plan);
          ui.subText.textContent = `Fetching more‚Ä¶ ${topic.toUpperCase()} ${size}/220`;
          try{
            const items = await fetchBatch(catId, diff);
            addToBank(topic, items);
            if (topic !== "mixed") addToBank("mixed", items);
          }catch(e){}
        }
      }
      await new Promise(r=>setTimeout(r, 900));
    }
  }

  function resetWinnerState(){
    buzzWinner = 0;
    lockedGuessIndex = null;
    ui.b1.classList.remove("winner");
    ui.b2.classList.remove("winner");
    ui.options.querySelectorAll(".option-btn").forEach(b=>b.classList.remove("locked","correct"));
    stealAvailable = false;
    stealPlayer = 0;
  }

  function resetForNext(){
    clearInterval(timerInterval);
    paused = false;
    ui.pauseBtn.textContent = "Pause";
    timeLeft = QUESTION_SECONDS;
    ui.timer.style.width = "100%";
    ui.a.style.background = "#27ae60";
    ui.a.textContent = "ANSWER HIDDEN";
    setAnswerVisible(false);

    resetWinnerState();
    lockBuzzers(false);
    setAdminActive(true);

    clearOptions();
  }

  function startTimer(){
    clearInterval(timerInterval);
    timeLeft = QUESTION_SECONDS;
    ui.timer.style.width = "100%";

    timerInterval = setInterval(()=>{
      if (paused || lightningEnabled) return;
      timeLeft -= (TICK_MS/1000);
      const pct = Math.max(0, (timeLeft/QUESTION_SECONDS)*100);
      ui.timer.style.width = pct + "%";

      if (timeLeft <= 0){
        clearInterval(timerInterval);
        lockBuzzers(true);
        setAdminActive(true);
        toast("Time!");
      }
    }, TICK_MS);
  }

  function renderQuestion(qObj){
    currentQ = qObj;
    ui.cat.textContent = (qObj.cat || "Trivia").toUpperCase();
    ui.q.textContent = qObj.q || "‚Äî";
    ui.a.textContent = qObj.a || "‚Äî";
    setAnswerVisible(false);
    renderOptions(qObj);
  }

  function pushUndo(){
    undoStack.push({
      p1Score, p2Score,
      best10Enabled, matchQCount, matchLocked, suddenDeath,
      lightningEnabled, lightningTimeLeft,
      buzzWinner, lockedGuessIndex, stealAvailable, stealPlayer
    });
    if (undoStack.length > 15) undoStack.shift();
  }

  function undo(){
    const last = undoStack.pop();
    if (!last){ toast("Nothing to undo"); return; }

    p1Score = last.p1Score;
    p2Score = last.p2Score;
    best10Enabled = last.best10Enabled;
    matchQCount = last.matchQCount;
    matchLocked = last.matchLocked;
    suddenDeath = last.suddenDeath;

    lightningEnabled = last.lightningEnabled;
    lightningTimeLeft = last.lightningTimeLeft;

    buzzWinner = last.buzzWinner;
    lockedGuessIndex = last.lockedGuessIndex;
    stealAvailable = last.stealAvailable;
    stealPlayer = last.stealPlayer;

    updateScores();
    ui.modeText.textContent = best10Status();
    toast("Undone");
  }

  function handleBuzz(player){
    if (paused || lightningEnabled) return;
    if (!currentQ) return;
    if (buzzWinner !== 0) return;
    if (ui.controls.classList.contains("locked")) return;

    buzzWinner = player;
    sfxBuzz();

    clearInterval(timerInterval);
    lockBuzzers(true);
    setAdminActive(true);

    if (player === 1) ui.b1.classList.add("winner");
    else ui.b2.classList.add("winner");

    toast(`${player === 1 ? names.p1 : names.p2} buzzed!`);
  }

  function showAnswer(){
    if (!currentQ) return;
    setAnswerVisible(true);
    revealCorrectOption();
  }

  function markCorrect(){
    if (!currentQ) return;
    pushUndo();

    if (buzzWinner === 0 && !lightningEnabled){
      toast("No buzz ‚Äî no point");
      sfxWrong();
      return;
    }

    if (!lightningEnabled){
      if (buzzWinner === 1) p1Score++;
      else p2Score++;
    }

    updateScores();
    ui.a.style.background = "#2ecc71";
    sfxCorrect();
    toast("Point +1");
    setTimeout(()=> ui.a.style.background="#27ae60", 420);
  }

  function markWrong(){
    if (!currentQ) return;
    pushUndo();

    ui.a.style.background = "#e74c3c";
    sfxWrong();
    toast("Wrong");

    if (stealMode && !lightningEnabled && buzzWinner !== 0){
      stealAvailable = true;
      stealPlayer = (buzzWinner === 1) ? 2 : 1;
      lockBuzzers(false);
      toast(`Steal: ${stealPlayer === 1 ? names.p1 : names.p2}`);
    }

    setTimeout(()=> ui.a.style.background="#27ae60", 420);
  }

  function endBest10(){
    matchLocked = true;
    lockBuzzers(true);
    setAdminActive(true);
    setAnswerVisible(true);
    clearInterval(timerInterval);

    let msg = "ü§ù Tie game!";
    if (p1Score > p2Score) msg = `üèÜ ${names.p1} wins!`;
    if (p2Score > p1Score) msg = `üèÜ ${names.p2} wins!`;

    ui.cat.textContent = "MATCH OVER";
    ui.q.textContent = msg;
    ui.a.textContent = "Tap Reset to play again.";
    ui.timer.style.width = "0%";
    toast("Match finished");
  }

  function checkSuddenDeathAfterScore(){
    if (!best10Enabled || !suddenDeath) return;
    if (p1Score !== p2Score){
      endBest10();
    } else {
      toast("Still tied ‚Äî next tiebreak question");
    }
  }

  function getNextQuestionObj(forLightning=false){
    const topic = getSelectedTopic();
    let qObj = pickFromDeck(topic);
    if (!qObj && topic !== "custom") qObj = pickFromDeck("custom");
    if (!qObj && topic !== "mixed") qObj = pickFromDeck("mixed");
    return qObj;
  }

  function nextQuestion(){
    if (matchLocked){
      toast("Match finished ‚Äî Reset");
      return;
    }

    if (best10Enabled && !suddenDeath){
      if (matchQCount >= BEST10_MAX_Q){
        if (p1Score === p2Score){
          suddenDeath = true;
          toast("Sudden death!");
        } else {
          endBest10();
          return;
        }
      }
    }

    if (best10Enabled && !suddenDeath){
      matchQCount++;
    }

    resetForNext();

    const qObj = getNextQuestionObj(false);
    if (!qObj){
      ui.cat.textContent = "DONE";
      ui.q.textContent = "No more unique questions this session.";
      ui.a.textContent = "Refresh to reset question pool.";
      setAnswerVisible(true);
      lockBuzzers(true);
      setAdminActive(true);
      return;
    }

    renderQuestion(qObj);
    ui.modeText.textContent = best10Status();
    startTimer();
  }

  function togglePause(){
    if (!currentQ && !lightningEnabled){
      toast("Start a question first");
      return;
    }
    paused = !paused;
    ui.pauseBtn.textContent = paused ? "Resume" : "Pause";

    if (paused){
      lockBuzzers(true);
      setAdminActive(true);
      toast("Paused");
    } else {
      if (!lightningEnabled){
        if (buzzWinner === 0 && timeLeft > 0){
          lockBuzzers(false);
        }
      }
      toast("Resumed");
    }
  }

  function toggleRandom(){
    randomCategory = !randomCategory;
    ui.randomBtn.classList.toggle("on", randomCategory);
    ui.randomBtn.textContent = randomCategory ? "RANDOM: ON" : "RANDOM: OFF";
    toast(randomCategory ? "Random ON" : "Random OFF");
  }

  function toggleBest10(){
    best10Enabled = !best10Enabled;
    suddenDeath = false;
    matchLocked = false;
    matchQCount = 0;

    ui.best10Btn.classList.toggle("on", best10Enabled);
    ui.best10Btn.textContent = best10Enabled ? "BEST10: ON" : "BEST10";
    ui.modeText.textContent = best10Status();
    toast(best10Enabled ? "Best of 10 ON" : "Best of 10 OFF");
  }

  function toggleSteal(){
    stealMode = !stealMode;
    ui.stealBtn.classList.toggle("on", stealMode);
    ui.stealBtn.textContent = stealMode ? "STEAL: ON" : "STEAL: OFF";
    toast(stealMode ? "Steal ON" : "Steal OFF");
  }

  function toggleSfx(){
    sfxOn = !sfxOn;
    ui.sfxBtn.classList.toggle("on", sfxOn);
    ui.sfxBtn.textContent = sfxOn ? "SFX: ON" : "SFX: OFF";
    toast(sfxOn ? "Sound ON" : "Sound OFF");
  }

  function editNames(){
    const p1 = prompt("Player 1 name:", names.p1);
    if (p1 === null) return;
    const p2 = prompt("Player 2 name:", names.p2);
    if (p2 === null) return;
    names.p1 = (p1.trim() || "Player 1");
    names.p2 = (p2.trim() || "Player 2");
    saveNames();
    applyNames();
    toast("Names updated");
  }

  function resetAll(){
    clearInterval(timerInterval);

    paused = false;
    ui.pauseBtn.textContent = "Pause";

    p1Score = 0; p2Score = 0;
    updateScores();

    best10Enabled = false;
    suddenDeath = false;
    matchLocked = false;
    matchQCount = 0;

    stealAvailable = false;
    stealPlayer = 0;
    lockedGuessIndex = null;

    undoStack.length = 0;
    playedKeys.clear();
    working.clear();

    ui.best10Btn.classList.remove("on");
    ui.best10Btn.textContent = "BEST10";
    ui.modeText.textContent = "READY";

    ui.cat.textContent = "CUSTOM";
    ui.q.textContent = 'Tap ‚ÄúNext ‚Üí‚Äù to start!';
    ui.a.textContent = "ANSWER HIDDEN";
    setAnswerVisible(false);
    ui.timer.style.width = "100%";

    resetWinnerState();
    clearOptions();
    lockBuzzers(false);

    for (const topic of banks.keys()) resetWorkingDeck(topic);
    toast("Reset");
  }

  // Category change disables random so it actually sticks
  ui.categorySelect.addEventListener("change", ()=>{
    randomCategory = false;
    ui.randomBtn.classList.remove("on");
    ui.randomBtn.textContent = "RANDOM: OFF";
    toast("Category set");
  });

  ui.b1.addEventListener("click", ()=> handleBuzz(1));
  ui.b2.addEventListener("click", ()=> handleBuzz(2));

  ui.showBtn.addEventListener("click", showAnswer);

  ui.correctBtn.addEventListener("click", ()=>{
    const before1 = p1Score, before2 = p2Score;
    markCorrect();
    if (best10Enabled && suddenDeath && (p1Score !== before1 || p2Score !== before2)){
      checkSuddenDeathAfterScore();
    }
  });

  ui.wrongBtn.addEventListener("click", markWrong);
  ui.nextBtn.addEventListener("click", nextQuestion);

  ui.undoBtn.addEventListener("click", undo);
  ui.pauseBtn.addEventListener("click", togglePause);
  ui.resetBtn.addEventListener("click", resetAll);

  ui.randomBtn.addEventListener("click", toggleRandom);
  ui.best10Btn.addEventListener("click", toggleBest10);
  ui.namesBtn.addEventListener("click", editNames);
  ui.stealBtn.addEventListener("click", toggleSteal);
  ui.sfxBtn.addEventListener("click", toggleSfx);

  // Lightning button stays (no-op in this compact version for now)
  ui.lightningBtn.addEventListener("click", ()=> toast("Lightning stays ON in your other version"));

  function initBanks(){
    const topics = ["mixed","custom","tv","movies","music","science","history","computers","pop","80s","90s","2000s","disney","ww2"];
    topics.forEach(ensureBank);

    addToBank("custom", ALL_CUSTOM);
    addToBank("mixed", ALL_CUSTOM);

    topics.forEach(resetWorkingDeck);
  }

  async function init(){
    loadNames(); applyNames();
    initBanks();

    setAdminActive(true);
    lockBuzzers(false);
    setAnswerVisible(false);
    ui.a.textContent = "ANSWER HIDDEN";
    ui.q.textContent = 'Tap ‚ÄúNext ‚Üí‚Äù to start!';
    ui.cat.textContent = "CUSTOM";
    ui.modeText.textContent = "READY";

    setLoading(true, "READY", "Connecting‚Ä¶");
    apiToken = await getToken();
    if (!apiToken){
      setLoading(false, "READY", "Offline mode (custom only)");
      return;
    }

    setLoading(true, "READY", "Warming up‚Ä¶");
    await warmupOnlineBanks();
    setLoading(false, "READY", "Online ready ‚Ä¢ Loading more‚Ä¶");

    setTimeout(()=> backgroundFillLoop(), 600);
  }

  init();
})();
</script>
</body>
</html>